---
import type { Entry } from "@lib/craft-cms/fetch-content";
import fetchContent from "@lib/craft-cms/fetch-content";
import cacheEntries from "@lib/craft-cms/cache-entries";
import cacheStaticPaths from "@lib/craft-cms/cache-static-paths";
import url from "@lib/craft-cms/url";

interface Config {
  hasDynamicRoutes?: boolean;
  query: string;
  sectionHandle: string;
  uriPrefix?: string;
}

interface Props {
  config: Config;
  slug?: string;
}

const {
  config: { query, sectionHandle, uriPrefix },
  slug,
}: Props = Astro.props;

/**
 * Near @DUPE layouts/SectionLayout.astro, pages/example-route/index.astro
 */
let entries: Entry[] = [];

if (import.meta.env.DEV) {
  entries = await fetchContent({ query });
  await cacheEntries({ entries, uriPrefix });
  await cacheStaticPaths({ entries, uriPrefix });
} else {
  const allSectionsEntries = await Astro.glob("@data/**/entries.json");

  entries = allSectionsEntries
    .map((data) => data.default)
    .find((entries: any) => entries[0].sectionHandle === sectionHandle);
}

const entry = entries.find(
  (entry) =>
    url(entry.uri) === "/" + [uriPrefix, slug].filter((v) => v).join("/")
);

if (!entry) {
  Astro.redirect("404");
}

const EntryLayout = await import(`./sections/${sectionHandle}.astro`).then(
  (m) => m.default
);
---

<EntryLayout entry={entry} />
